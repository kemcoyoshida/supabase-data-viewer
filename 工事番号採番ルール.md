# 工事番号採番ルール 詳細仕様書

## 概要

このシステムは、**工事番号台の最初の1文字または2文字（プレフィックス）**によって、その後の番号の自動採番ルールが決定される仕組みです。プレフィックスを識別することで、適切な桁数とリセット条件が自動的に適用されます。

---

## 📋 採番ルール一覧表

| グループ | プレフィックス例 | 番号構成 | カウント範囲 | リセット条件 | 最大件数 |
|---------|----------------|---------|------------|------------|---------|
| **① 英字1文字型** | S, T, Z, D | 英(1) + 数(3) | 001 ～ 999 | 999 の次は 001 | 999件 |
| **② 複合2文字型** | 3B, 4C, 5E, 7P など | 英数(2) + 数(2) | 01 ～ 99 | 99 の次は 01 | 99件 |
| **③-A 標準数字型** | 10, 29, 39, 49, 50, 60, 70, 80, 90 | 全体が数字(4) | 下3桁を連番 | 999 の次は 001 | 999件 |
| **③-B 特殊数字型** | 20, 30, 40 | 全体が数字(4) | 下3桁を連番 | 899 の次は 001 | 899件 |

---

## 🔍 各グループの詳細仕様

### ① 英字1文字グループ（S, T, Z, D）

**特徴**: 1文字のアルファベットで工事区分を表すタイプ

**採番方法**:
- 1文字目の英字は固定
- 続く3桁の数字を +1 でカウント
- 数字部分は001から開始し、999まで連番

**リセット条件**: 999 に達したら 001 に戻る

**対応プレフィックス**:
- `S` → S001, S002, ..., S999, S001（リセット）
- `T` → T001, T002, ..., T999, T001（リセット）
- `Z` → Z001, Z002, ..., Z999, Z001（リセット）
- `D` → D001, D002, ..., D999, D001（リセット）

**例**:
```
D001 → D002 → D003 → ... → D999 → D001（リセット）
```

**コード実装**:
```javascript
// 1文字目から3文字を取得（数字部分）
const num = parseInt(retStr.substring(1, 4), 10) + 1;
return 'D' + String(num).padStart(3, '0');
```

---

### ② 複合2文字グループ（英数字混合）

**特徴**: 数字と英字を組み合わせた2文字のプレフィックス

**採番方法**:
- 最初の2文字（例：3B, 4C）は固定
- 下2桁の数字だけを +1 でカウント
- 数字部分は01から開始し、99まで連番

**リセット条件**: 99 に達したら 01 に戻る

**対応プレフィックス**:
- **3系**: `3B`, `3C`, `3V`, `3P`, `3T`
- **4系**: `4B`, `4C`, `4V`, `4P`, `4T`
- **5系**: `5B`, `5E`
- **7系**: `7P`
- **8系**: `8B`, `8E`

**例**:
```
3B01 → 3B02 → 3B03 → ... → 3B99 → 3B01（リセット）
4C01 → 4C02 → 4C03 → ... → 4C99 → 4C01（リセット）
```

**コード実装**:
```javascript
// 3文字目から2文字を取得（数字部分）
const num = parseInt(retStr.substring(2, 4), 10) + 1;
return '4C' + String(num).padStart(2, '0');
```

---

### ③-A 標準数字型グループ

**特徴**: 4桁すべてが数字で、最初の2桁がプレフィックス

**採番方法**:
- 最初の2桁（例：10, 29）は固定
- 下2桁を含む全体を数値として +1 でカウント
- 下3桁が連番として機能

**リセット条件**: 下3桁が999に達したら、001に戻る

**対応プレフィックス**:
- `10` → 1001 ～ 1999 → 1001（リセット）
- `29` → 2901 ～ 2999 → 2901（リセット）
- `39` → 3901 ～ 3999 → 3901（リセット）
- `49` → 4901 ～ 4999 → 4901（リセット）
- `50` → 5001 ～ 5999 → 5001（リセット）
- `60` → 6001 ～ 6999 → 6001（リセット）
- `70` → 7001 ～ 7999 → 7001（リセット）
- `80` → 8001 ～ 8999 → 8001（リセット）
- `90` → 9001 ～ 9999 → 9001（リセット）

**例**:
```
1001 → 1002 → 1003 → ... → 1999 → 1001（リセット）
5001 → 5002 → 5003 → ... → 5999 → 5001（リセット）
```

**コード実装**:
```javascript
if (retStr === '1999') {
    return '1001';  // リセット
} else {
    return String(parseInt(retStr, 10) + 1);
}
```

---

### ③-B 特殊数字型グループ（20, 30, 40）

**特徴**: 標準数字型と同じ4桁数字だが、リセット条件が異なる

**採番方法**:
- 最初の2桁（20, 30, 40）は固定
- 下2桁を含む全体を数値として +1 でカウント
- **リセット条件が特殊**: 下3桁が899に達したら、001に戻る

**対応プレフィックス**:
- `20` → 2001 ～ 2899 → 2001（リセット）
- `30` → 3001 ～ 3899 → 3001（リセット）
- `40` → 4001 ～ 4899 → 4001（リセット）

**例**:
```
2001 → 2002 → 2003 → ... → 2899 → 2001（リセット）
3001 → 3002 → 3003 → ... → 3899 → 3001（リセット）
4001 → 4002 → 4003 → ... → 4899 → 4001（リセット）
```

**コード実装**:
```javascript
if (retStr === '2899') {  // 20番台の場合
    return '2001';  // リセット
} else {
    return String(parseInt(retStr, 10) + 1);
}
```

**注意**: 標準数字型（10, 29など）は999までカウントしますが、このグループは899でリセットされます。

---

## 🔄 システムの自動判定フローチャート

```
工事番号台を入力
    ↓
「番台」を削除してプレフィックスを抽出
    ↓
最初の1文字を確認
    ↓
┌─────────────────────────────────┐
│ 1文字目が英字（A-Z）か？        │
└─────────────────────────────────┘
    │
    ├─ YES → 【グループ①】英字1文字型
    │         例：S, T, Z, D
    │         処理：1文字固定 + 3桁数字（001-999）
    │
    └─ NO  → 最初の2文字を確認
              ↓
        ┌─────────────────────────────────┐
        │ 2文字目が英字（A-Z）か？        │
        └─────────────────────────────────┘
            │
            ├─ YES → 【グループ②】複合2文字型
            │         例：3B, 4C, 5E, 7P, 8B
            │         処理：2文字固定 + 2桁数字（01-99）
            │
            └─ NO  → 【グループ③】数字2文字型
                      ↓
                  ┌─────────────────────────────────┐
                  │ プレフィックスが 20, 30, 40 か？ │
                  └─────────────────────────────────┘
                      │
                      ├─ YES → 【グループ③-B】特殊数字型
                      │         処理：4桁数字、899でリセット
                      │
                      └─ NO  → 【グループ③-A】標準数字型
                               処理：4桁数字、999でリセット
```

---

## 📊 プレフィックス一覧（全対応リスト）

### グループ① 英字1文字型
| プレフィックス | 初期値 | 最大値 | リセット値 |
|--------------|--------|--------|----------|
| S | S001 | S999 | S001 |
| T | T001 | T999 | T001 |
| Z | Z001 | Z999 | Z001 |
| D | D001 | D999 | D001 |

### グループ② 複合2文字型
| プレフィックス | 初期値 | 最大値 | リセット値 |
|--------------|--------|--------|----------|
| 3B | 3B01 | 3B99 | 3B01 |
| 3C | 3C01 | 3C99 | 3C01 |
| 3V | 3V01 | 3V99 | 3V01 |
| 3P | 3P01 | 3P99 | 3P01 |
| 3T | 3T01 | 3T99 | 3T01 |
| 4B | 4B01 | 4B99 | 4B01 |
| 4C | 4C01 | 4C99 | 4C01 |
| 4V | 4V01 | 4V99 | 4V01 |
| 4P | 4P01 | 4P99 | 4P01 |
| 4T | 4T01 | 4T99 | 4T01 |
| 5B | 5B01 | 5B99 | 5B01 |
| 5E | 5E01 | 5E99 | 5E01 |
| 7P | 7P01 | 7P99 | 7P01 |
| 8B | 8B01 | 8B99 | 8B01 |
| 8E | 8E01 | 8E99 | 8E01 |

### グループ③-A 標準数字型
| プレフィックス | 初期値 | 最大値 | リセット値 |
|--------------|--------|--------|----------|
| 10 | 1001 | 1999 | 1001 |
| 29 | 2901 | 2999 | 2901 |
| 39 | 3901 | 3999 | 3901 |
| 49 | 4901 | 4999 | 4901 |
| 50 | 5001 | 5999 | 5001 |
| 60 | 6001 | 6999 | 6001 |
| 70 | 7001 | 7999 | 7001 |
| 80 | 8001 | 8999 | 8001 |
| 90 | 9001 | 9999 | 9001 |

### グループ③-B 特殊数字型
| プレフィックス | 初期値 | 最大値 | リセット値 |
|--------------|--------|--------|----------|
| 20 | 2001 | 2899 | 2001 |
| 30 | 3001 | 3899 | 3001 |
| 40 | 4001 | 4899 | 4001 |

---

## 💡 使用例

### 例1: D番台の採番
```
使用済み番号: D001
次の番号: D002 ✅

使用済み番号: D001, D002, D003
次の番号: D004 ✅

使用済み番号: D999
次の番号: D001 ✅（リセット）
```

### 例2: 4C番台の採番
```
使用済み番号: 4C01
次の番号: 4C02 ✅

使用済み番号: 4C01, 4C02, 4C03
次の番号: 4C04 ✅

使用済み番号: 4C99
次の番号: 4C01 ✅（リセット）
```

### 例3: 10番台の採番
```
使用済み番号: 1001
次の番号: 1002 ✅

使用済み番号: 1001, 1002, 1998
次の番号: 1999 ✅

使用済み番号: 1999
次の番号: 1001 ✅（リセット）
```

### 例4: 20番台の採番（特殊）
```
使用済み番号: 2001
次の番号: 2002 ✅

使用済み番号: 2898
次の番号: 2899 ✅

使用済み番号: 2899
次の番号: 2001 ✅（リセット、899でリセット）
```

---

## ⚙️ システムの動作仕様

### 自動採番の流れ

1. **工事番号台の選択**
   - ユーザーが「工事番号台」ドロップダウンから選択
   - 例：「D000番台」「4C00番台」「1000番台」など

2. **プレフィックスの抽出**
   - 「番台」という文字列を削除
   - 最初の1文字または2文字をプレフィックスとして識別

3. **使用済み番号の取得**
   - データベースから該当プレフィックスの工事番号を取得
   - ローカルストレージの「使用済み工事番号一覧」も取得
   - 両方を統合して最大値を検索

4. **次の番号の計算**
   - 最大値が見つかった場合：その最大値に +1
   - 最大値が見つからない場合：初期値（例：D001, 4C01, 1001）を返す
   - リセット条件に達している場合：リセット値（例：D001, 4C01, 1001）を返す

5. **使用済み番号の記録**
   - 生成された番号を「使用済み工事番号一覧」に保存
   - 次回の採番時に重複を防ぐ

### プレフィックス判定の優先順位

1. **1文字目が英字（A-Z）** → グループ①（最優先）
2. **2文字目が英字（A-Z）** → グループ②
3. **すべて数字** → グループ③-A または ③-B

---

## 🔧 技術的な実装詳細

### プレフィックス抽出ロジック

```javascript
// 「番台」を削除
let koujiValue = koujibangou.replace('番台', '').trim();

// 1文字目がアルファベットの場合
if (koujiValue.length >= 1 && /^[A-Z]$/.test(koujiValue.substring(0, 1))) {
    prefix1 = koujiValue.substring(0, 1);  // S, T, Z, D
    prefix = '';
}
// 2文字以上の場合は2文字プレフィックス
else if (koujiValue.length >= 2) {
    prefix = koujiValue.substring(0, 2);   // 3B, 4C, 10, 20 など
    prefix1 = koujiValue.substring(0, 1);
}
```

### 使用済み番号のマッチング

```javascript
// グループ①の場合（1文字アルファベット）
if (prefix1 && /^[A-Z]$/.test(prefix1)) {
    if (strValue.startsWith(prefix1)) {
        allNumbers.push(strValue);  // D001, D002 など
    }
}
// グループ②・③の場合（2文字プレフィックス）
else if (prefix) {
    if (strValue.startsWith(prefix)) {
        allNumbers.push(strValue);  // 4C01, 4C02 など
    }
}
```

### 最大値の計算

```javascript
// 各番号から数値部分を抽出
const numberPairs = allNumbers.map(num => {
    const strValue = String(num).trim();
    let numValue = 0;
    
    if (prefix1 && /^[A-Z]$/.test(prefix1)) {
        // グループ①: 1文字目以降を数値として扱う
        numPart = strValue.substring(1);  // "001"
        numValue = parseInt(numPart, 10);  // 1
    } else if (prefix && prefix.length === 2) {
        // グループ②: 3文字目以降を数値として扱う
        numPart = strValue.substring(2);   // "01"
        numValue = parseInt(numPart, 10);  // 1
    }
    
    return { original: strValue, numValue: numValue };
});

// 数値でソートして最大値を取得
numberPairs.sort((a, b) => b.numValue - a.numValue);
maxNumber = numberPairs[0].original;
```

---

## 📝 注意事項

1. **リセット条件の違い**
   - グループ③-B（20, 30, 40）は899でリセット
   - グループ③-A（10, 29など）は999でリセット
   - この違いは意図的な仕様です

2. **使用済み番号の管理**
   - 採番された番号は自動的に「使用済み工事番号一覧」に追加されます
   - データベースに登録された番号も考慮されます
   - 両方の最大値を比較して、より大きい方を基準に次の番号を生成します

3. **プレフィックスの大文字小文字**
   - アルファベットは大文字（A-Z）のみ対応
   - 小文字は使用できません

4. **番号の重複防止**
   - システムは使用済み番号を自動的にチェックします
   - 同じ番号が2回生成されることはありません

---

## 🎯 まとめ

このシステムは、**最初の1文字または2文字（プレフィックス）**によって自動的に採番ルールを決定します。ユーザーは工事番号台を選択するだけで、適切な次の番号が自動生成されます。

- **グループ①**: 1文字英字 → 3桁数字（001-999）
- **グループ②**: 2文字英数字 → 2桁数字（01-99）
- **グループ③-A**: 2文字数字 → 4桁数字、999でリセット
- **グループ③-B**: 2文字数字 → 4桁数字、899でリセット（20, 30, 40のみ）

すべての採番は自動化されており、手動での番号入力は不要です。








